# データベースの基礎知識と環境構築

- データ型について
  - 固定長文字列型はサイズの指定が必要。その数値に足りない分は空白が補填される。
  - リスト型は文字列を配列として扱う型で、複数の文字データを 1 つのカラムで扱える(ENUM)
  - 数値型には SIGNED と UNSIGNED の 2 つがあり、UN は負数を扱えない替わりに正数の範囲が 2 倍使える
  - SQL は大文字と小文字を区別しない
  - データベース一覧から使用するデータベースを選択　 USE コマンド

# データ操作の基本(DML)

## データ操作言語とは

- DML…Data Manipulation Language 　 DB に命令をするための言語
- コマンド…クエリ 1 行全部
- 式…条件式、絞り込みの条件など
- 句…SELECT 句　とか　 FROM 句　みたいな構成の一つのこと

## データを取得する

- 並び替え・・・ORDER BY [カラム] ASC or DESC;
- ORDER BY をつけない場合のデータの取得順は『不規則』であり、確実性を持たせたいなら必ず ORDER BY を使たほうがよい。
- カラム指定せずに\*で全部取得できるが、後々の拡張性を考えると各カラムを指定するクエリを作ってるほうが望ましい。
- 末尾に where 句＋比較演算子で特定のレコードのみを取得
- 検索対象が文字列型データの場合は''で囲む必要あり
- where 句に and／or で複数条件指定可能
  - この二つが入り混じる場合は and 条件から先に検索されていくので、どこからどこまでの内容を and で繋ぐのか、文全体の構成に注意が必要(掛け算みたいな形)
- 数値の範囲指定には between 句が使用可能。and で 2 個繋ぐよりベター。
  - 範囲がない数値の指定には IN(1,2,3...)で個別指定可能
- where 句のあとに like 句であいまい検索が可能
- select 句の直後に distinct[カラム名]で、重複データを省いて取得が可能(全種類の一覧の取得が可能。)

  - 複数カラムを指定すると、その組み合わせで重複がないように取得可能。

- case 文 ・・・プログラミング言語の if 文的使い方が可能。WHEN と THEN と組み合わせて、条件によってデータを変えて取得する。AS を使って抽出結果のカラムに別名を付けられる。

## データを追加する

- INSERT INTO・・・レコードの追加。カラム名、それに対する値を順番に指定。
- カラム名の指定を省いた場合、values ですべてのカラムに値の指定が必要。⇨ 拡張性がないため、使いまわすような場面ではできればカラムは指定したほうがよい。
- values(,,,)のカッコをカンマ区切りで複数指定すると、1 回で複数レコードを挿入するクエリが発行できる。
- テーブル名とか values の後ろに半角スペース忘れただけでもエラーなるので注意。
- where で書き換え対象のカラムのレコードを指定することで、置換みたいな動きにすることも可能。(金額が 300 円のものを 400 円に UPDATE する、みたいな感じで。)

## データを変更する

- UPDATE・・・データの変更。SET [カラム] = [値]　で指定。where 句で対象レコードを指定しないと、対象テーブルのすべてのレコードに適用されてしまうので注意が必要。

## データを削除する

-DELETE・・・レコードの削除。UPDATE と同じく where 句で対象レコードを絞り込まないと、対象テーブルが空っぽになってしまうので注意。

# データ定義言語(DDL)とデータ制御言語(DCL)

## DDL とは

DDL・・・データベースの構造を定義するための言語。データベースそのものや、データを入れておくテーブルなどのデータベースオブジェクトの定義を行う。下記 3 種。

- CREATE・・・DB オブジェクト作成
- ALTER・・・〃変更。文字コード・暗号化・読み取り専用属性・オフライン・アクセス権限・保存場所・サイズなどを変更可能。
- DROP・・・削除

- alter table でカラムの追加や変更可能。
  - add 句でカラム追加
  - カラム追加の際、after 句でカラムの追加位置を指定可能。これは MySQL 特有の機能の模様。
  - modify 句で既存カラムの設定変更。既存のデータの長さや型の違いから、変更可能なものは限定的。文字列 ⇨ 数値型は × など。
- カラムの削除には alter table の中に drop 句がくる。
- alter table の 1 クエリの中で add や modify や drop などをまとめて実行できる。
- テーブル自体を削除する場合は drop table テーブル名　これだけ。

## DCL とは

DCL・・・データに対するアクセス制御を行うためのデータベース言語。トランザクション処理など。

- BEGIN・・・トランザクション処理の開始の宣言
- COMMIT・・・確定
- ROLLBACK・・・確定前の変更内容のロールバック

## ビューを利用しよう

テーブルのデータを加工して作成した仮想的な表。create view view 名 as select 文。

# 実践的な SQL を学ぼう

## データ型に関する操作の基本

### 文字列操作の基本

- RIGHT/LEFT・・・左右から〇文字を取得する関数。
- SUBSTRING・・・左から〇文字目から △ 文字取得する関数。(間を取得)
- LOWER/UPPER・・・大文字 ⇔ 小文字変換の関数。
- TRIM・・・文字列の前後にある半角の空白を削除したい場合に使用。
  - LTRIM/RTRIM・・・左端/右端の空白だけを削除。
- LENGTH・・・文字列の長さを求める関数。ソフトによって仕様が異なるため注意が必要。MySQL では文字数ではなくバイト数を返す。MySQL で全角文字も文字数で取得したければ、CHARACTER_LENGTH 関数となる。
- LPAD/RLAD・・・文字列の前方もしくは後方に特定の文字列を補填する関数。補填後の文字数と、補填する文字そのものを指定。
- REPLACE・・・特定の文字列を別の文字列に置換して取得。郵便番号のハイフンを空文字に変換して取得する場合など。
- INSTR・・・指定した文字が損歳する『位置』を前方からの文字数で取得。存在自体のチェックに使用されたり、半角スペースを基準に姓名を分けたりなどに使える。

### 数値操作の基本

- MOD・・・剰余(余り)の計算用関数。
- ROUND・・・四捨五入。それを行う桁数の指定可能。
- TRUNCATE・・・桁位置を指定して切捨て。
- CEIL・・・〃切り上げ。が、桁位置の指定は不可(小数を整数にする)。そのたため、たとえば 1000 の位などで切り上げしたい場合、対象の数字に+9999 したものを TRUNCATE で切り捨てる、というような処理をする必要がある。

### 日付操作の基本

- CURRENT＿TIMESTAMP・・・現在の日時の取得
- CURRENT_DATE・・・日付のみ取得
- CURRENT_TIME・・・時刻のみを取得　いずれも引数不要。
- DATE_ADD・・・日付を加算。DAY、SECOND など、どの単位で加算したいかも指定可能。
- DATE_SUB・・・〃減算。DATE_ADD の引数をマイナスにして代用することも可能。

### データ型の変換

- CAST・・・型変換。とくに文字列型の数字の加減算などは DB の種類によって挙動がちがうため、キッチリ数値型に変換してから行うのが吉。
- DATE_FORMAT・・・日付型のデータを表示形式を指定して文字列型に変換。
- STR_TO_DATE・・・文字列を日付に変換。こちらも、指定する文字列がどのような日付フォーマットで表記されているかの指定が必要。

## テーブルを結合する

### 等結合(内部結合)

二つのテーブルにそれぞれキーとなるカラムを指定する。等結合は両方のテーブルのキーに、同じ値が存在するレコードのみを出力する

- FROM 句+INNER JOIN の書き方
- WHERE 句の中で書く書き方　どちらでも成立する

### 外部結合

複数のテーブルを繋ぐためにそれぞれキーとなるカラムを指定するのは内部結合と同じだが、参照先のテーブルのキーに同じ値がない場合でも、参照元のレコードはすべて表示する。

- 参照元 left outer join 参照先
- right 〃 でも書けるが、left で全部作れるのであえて right を使うことは少ない。

### 交差結合

結合したテーブルの全レコード同士を組み合わせたすべてのパターンが取得される。レコード 2 件のテーブルと 3 件のテーブルを交差結合すると、6 件の結果が返る。

- 結合条件式を一切記述しなかった場合、自動的に交差結合となる。
- CROSS JOIN と明示することも可能。

## データを集計する方法を学ぼう

集計関数・・・レコードの件数や、数値型のカラムの合計値・平均値・最大義・最小値などを求める関数。

- COUNT・・・件数の取得。対象を\*とした場合は全レコード件数。特定カラムとした場合は、そのカラムに NULL がある分はカウントされなくなる。
- SUM・・・合計値
- AVG・・・平均値。NULL は計算に入れられない。
- MAX/MIN・・・対象カラムの最大値・最小値。

# 応用的な SQL を学ぼう

## 高度な集計を行うには

### グループごとに集計を行う

- GROUP BY・・・指定した『カラムの値』ごとにグループ化して集計を行う。対象カラムを複数指定したい場合はカンマで区切って複数のカラムを指定。

### グループごとに集計した結果からさらに絞り込む

- HAVING・・・WHERE 句が集計前のレコードの絞り込みをしたのに対し、HAVING 句は集計後のレコードからさらに絞り込むために条件を指定できる。

## サブクエリーを利用する

SQL 文の中に書かれたもう一つの SQL 文。副問い合わせとも呼ばれる。SELECT 句・FROM 句・WHERE 句内でそれぞれ使うことができ、どの句内で使うかによって制約や抽出結果の使われ方などが異なってくる。

- SELECT 句での使用・・・SELECT 句の中だけで他のテーブルの値を取得できる。
  - サブクエリーの SELECT 句に指定できるのは 1 カラムのみ。
  - サブクエリーの結果は 1 レコード。
- FROM 句での使用・・・テーブルの替わりにサブクエリーを指定する。
  - サブクエリーの SELECT 句には、複数カラムの指定が可能。
  - サブクエリーの結果は、複数レコードも可能。
- WHERE 句での使用・・・他のテーブルの特定の条件を満たす値を、検索条件として使用する。
  - EXISTS 句や IN 句でも利用可能。

## データの存在チェックを行うには



# メモ

- 一部の SQL 文では FROM 句のない SQL 文が実行可能。oracle は対象外。
- 取得データを外部ファイルに出力可能。my.ini ファイルを編集して出力先のアクセス許可の設定が必要。
- 文字列でも、例えばカラム名の指定なんかでは''が必要ない模様。

- DESCRIBE テーブル名; でカラム一覧や各カラムの制約などを確認可能。
- SQL の関数は、関数の踊り地を別の関数の引数として使用することができる。(関数の複合的な使用が可能。)
- テーブル名は AS でエイリアス名を充てることが可能。SQL 全体をスッキリ書くことに役立つ。
- 各句の記述優先順は下記の通り。
  1. SELECT
  1. FROM
  1. WHERE
  1. GROUP BY
  1. HABING
  1. ORDER BY
